"use strict";var _a,_b,_c,_d;Object.defineProperty(exports,"__esModule",{value:!0}),exports.CloudFormationDeleteStackAction=exports.CloudFormationCreateUpdateStackAction=exports.CloudFormationCreateReplaceChangeSetAction=exports.CloudFormationExecuteChangeSetAction=void 0;const jsiiDeprecationWarnings=require("../../../.warnings.jsii.js"),JSII_RTTI_SYMBOL_1=Symbol.for("jsii.rtti"),cloudformation=require("../../../aws-cloudformation"),codepipeline=require("../../../aws-codepipeline"),iam=require("../../../aws-iam"),cdk=require("../../../core"),constructs_1=require("constructs"),action_1=require("../action");class CloudFormationAction extends action_1.Action{constructor(props,inputs){super({...props,provider:"CloudFormation",category:codepipeline.ActionCategory.DEPLOY,artifactBounds:{minInputs:0,maxInputs:10,minOutputs:0,maxOutputs:1},inputs,outputs:props.outputFileName?[props.output||new codepipeline.Artifact(`${props.actionName}_${props.stackName}_Artifact`)]:void 0});this.props=props}bound(_scope,_stage,options){const singletonPolicy=SingletonPolicy.forRole(options.role);return(this.actionProperties.outputs||[]).length>0?options.bucket.grantReadWrite(singletonPolicy):(this.actionProperties.inputs||[]).length>0&&options.bucket.grantRead(singletonPolicy),{configuration:{StackName:this.props.stackName,OutputFileName:this.props.outputFileName}}}}class CloudFormationExecuteChangeSetAction extends CloudFormationAction{constructor(props){super(props,void 0);jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_actions_CloudFormationExecuteChangeSetActionProps(props),this.props2=props}bound(scope,stage,options){jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_IStage(stage),jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_ActionBindOptions(options),SingletonPolicy.forRole(options.role).grantExecuteChangeSet(this.props2);const actionConfig=super.bound(scope,stage,options);return{...actionConfig,configuration:{...actionConfig.configuration,ActionMode:"CHANGE_SET_EXECUTE",ChangeSetName:this.props2.changeSetName}}}}exports.CloudFormationExecuteChangeSetAction=CloudFormationExecuteChangeSetAction,_a=JSII_RTTI_SYMBOL_1,CloudFormationExecuteChangeSetAction[_a]={fqn:"aws-cdk-lib.aws_codepipeline_actions.CloudFormationExecuteChangeSetAction",version:"2.10.0"};class CloudFormationDeployAction extends CloudFormationAction{constructor(props,inputs){super(props,(props.extraInputs||[]).concat(inputs||[]));this.props2=props}addToDeploymentRolePolicy(statement){return this.getDeploymentRole("method addToRolePolicy()").addToPolicy(statement)}get deploymentRole(){return this.getDeploymentRole("property role()")}bound(scope,stage,options){var _e,_f;if(this.props2.deploymentRole)this._deploymentRole=this.props2.deploymentRole;else{const roleStack=cdk.Stack.of(options.role),pipelineStack=cdk.Stack.of(scope);roleStack.account!==pipelineStack.account?this._deploymentRole=new iam.Role(roleStack,`${cdk.Names.nodeUniqueId(stage.pipeline.node)}-${stage.stageName}-${this.actionProperties.actionName}-DeploymentRole`,{assumedBy:new iam.ServicePrincipal("cloudformation.amazonaws.com"),roleName:cdk.PhysicalName.GENERATE_IF_NEEDED}):this._deploymentRole=new iam.Role(scope,"Role",{assumedBy:new iam.ServicePrincipal("cloudformation.amazonaws.com")}),options.bucket.grantRead(this._deploymentRole),this.props2.adminPermissions&&this._deploymentRole.addToPolicy(new iam.PolicyStatement({actions:["*"],resources:["*"]}))}SingletonPolicy.forRole(options.role).grantPassRole(this._deploymentRole);const providedCapabilities=(_e=this.props2.cfnCapabilities)!==null&&_e!==void 0?_e:(_f=this.props2.capabilities)===null||_f===void 0?void 0:_f.map(c=>{switch(c){case cloudformation.CloudFormationCapabilities.NONE:return cdk.CfnCapabilities.NONE;case cloudformation.CloudFormationCapabilities.ANONYMOUS_IAM:return cdk.CfnCapabilities.ANONYMOUS_IAM;case cloudformation.CloudFormationCapabilities.NAMED_IAM:return cdk.CfnCapabilities.NAMED_IAM;case cloudformation.CloudFormationCapabilities.AUTO_EXPAND:return cdk.CfnCapabilities.AUTO_EXPAND}}),capabilities=this.props2.adminPermissions&&providedCapabilities===void 0?[cdk.CfnCapabilities.NAMED_IAM]:providedCapabilities,actionConfig=super.bound(scope,stage,options);return{...actionConfig,configuration:{...actionConfig.configuration,Capabilities:parseCapabilities(capabilities),RoleArn:this.deploymentRole.roleArn,ParameterOverrides:cdk.Stack.of(scope).toJsonString(this.props2.parameterOverrides),TemplateConfiguration:this.props2.templateConfiguration?this.props2.templateConfiguration.location:void 0,StackName:this.props2.stackName}}}getDeploymentRole(member){if(this._deploymentRole)return this._deploymentRole;throw new Error(`Cannot use the ${member} before the Action has been added to a Pipeline`)}}class CloudFormationCreateReplaceChangeSetAction extends CloudFormationDeployAction{constructor(props){super(props,props.templateConfiguration?[props.templatePath.artifact,props.templateConfiguration.artifact]:[props.templatePath.artifact]);jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_actions_CloudFormationCreateReplaceChangeSetActionProps(props),this.props3=props}bound(scope,stage,options){jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_IStage(stage),jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_ActionBindOptions(options);const actionConfig=super.bound(scope,stage,options);return SingletonPolicy.forRole(options.role).grantCreateReplaceChangeSet(this.props3),{...actionConfig,configuration:{...actionConfig.configuration,ActionMode:"CHANGE_SET_REPLACE",ChangeSetName:this.props3.changeSetName,TemplatePath:this.props3.templatePath.location}}}}exports.CloudFormationCreateReplaceChangeSetAction=CloudFormationCreateReplaceChangeSetAction,_b=JSII_RTTI_SYMBOL_1,CloudFormationCreateReplaceChangeSetAction[_b]={fqn:"aws-cdk-lib.aws_codepipeline_actions.CloudFormationCreateReplaceChangeSetAction",version:"2.10.0"};class CloudFormationCreateUpdateStackAction extends CloudFormationDeployAction{constructor(props){super(props,props.templateConfiguration?[props.templatePath.artifact,props.templateConfiguration.artifact]:[props.templatePath.artifact]);jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_actions_CloudFormationCreateUpdateStackActionProps(props),this.props3=props}bound(scope,stage,options){jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_IStage(stage),jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_ActionBindOptions(options);const actionConfig=super.bound(scope,stage,options);return SingletonPolicy.forRole(options.role).grantCreateUpdateStack(this.props3),{...actionConfig,configuration:{...actionConfig.configuration,ActionMode:this.props3.replaceOnFailure?"REPLACE_ON_FAILURE":"CREATE_UPDATE",TemplatePath:this.props3.templatePath.location}}}}exports.CloudFormationCreateUpdateStackAction=CloudFormationCreateUpdateStackAction,_c=JSII_RTTI_SYMBOL_1,CloudFormationCreateUpdateStackAction[_c]={fqn:"aws-cdk-lib.aws_codepipeline_actions.CloudFormationCreateUpdateStackAction",version:"2.10.0"};class CloudFormationDeleteStackAction extends CloudFormationDeployAction{constructor(props){super(props,void 0);jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_actions_CloudFormationDeleteStackActionProps(props),this.props3=props}bound(scope,stage,options){jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_IStage(stage),jsiiDeprecationWarnings.aws_cdk_lib_aws_codepipeline_ActionBindOptions(options);const actionConfig=super.bound(scope,stage,options);return SingletonPolicy.forRole(options.role).grantDeleteStack(this.props3),{...actionConfig,configuration:{...actionConfig.configuration,ActionMode:"DELETE_ONLY"}}}}exports.CloudFormationDeleteStackAction=CloudFormationDeleteStackAction,_d=JSII_RTTI_SYMBOL_1,CloudFormationDeleteStackAction[_d]={fqn:"aws-cdk-lib.aws_codepipeline_actions.CloudFormationDeleteStackAction",version:"2.10.0"};class SingletonPolicy extends constructs_1.Construct{constructor(role){super(role,SingletonPolicy.UUID);this.role=role,this.statements={},this.grantPrincipal=role}static forRole(role){return role.node.tryFindChild(SingletonPolicy.UUID)||new SingletonPolicy(role)}grantExecuteChangeSet(props){this.statementFor({actions:["cloudformation:DescribeStacks","cloudformation:DescribeChangeSet","cloudformation:ExecuteChangeSet"],conditions:{StringEqualsIfExists:{"cloudformation:ChangeSetName":props.changeSetName}}}).addResources(this.stackArnFromProps(props))}grantCreateReplaceChangeSet(props){this.statementFor({actions:["cloudformation:CreateChangeSet","cloudformation:DeleteChangeSet","cloudformation:DescribeChangeSet","cloudformation:DescribeStacks"],conditions:{StringEqualsIfExists:{"cloudformation:ChangeSetName":props.changeSetName}}}).addResources(this.stackArnFromProps(props))}grantCreateUpdateStack(props){const actions=["cloudformation:DescribeStack*","cloudformation:CreateStack","cloudformation:UpdateStack","cloudformation:GetTemplate*","cloudformation:ValidateTemplate","cloudformation:GetStackPolicy","cloudformation:SetStackPolicy"];props.replaceOnFailure&&actions.push("cloudformation:DeleteStack"),this.statementFor({actions}).addResources(this.stackArnFromProps(props))}grantDeleteStack(props){this.statementFor({actions:["cloudformation:DescribeStack*","cloudformation:DeleteStack"]}).addResources(this.stackArnFromProps(props))}grantPassRole(role){this.statementFor({actions:["iam:PassRole"]}).addResources(role.roleArn)}statementFor(template){const key=keyFor(template);return key in this.statements||(this.statements[key]=new iam.PolicyStatement({actions:template.actions}),template.conditions&&this.statements[key].addConditions(template.conditions),this.role.addToPolicy(this.statements[key])),this.statements[key];function keyFor(props){const actions=`${props.actions.sort().join("")}`,conditions=formatConditions(props.conditions);return`${actions}${conditions}`;function formatConditions(cond){if(cond==null)return"";let result="";for(const op of Object.keys(cond).sort()){result+=`${op}`;const condition=cond[op];for(const attribute of Object.keys(condition).sort())result+=`${condition[attribute]}`}return result}}}stackArnFromProps(props){return cdk.Stack.of(this).formatArn({region:props.region,service:"cloudformation",resource:"stack",resourceName:`${props.stackName}/*`})}}SingletonPolicy.UUID="8389e75f-0810-4838-bf64-d6f85a95cf83";function parseCapabilities(capabilities){if(capabilities!==void 0){if(capabilities.length===1){const capability=capabilities.toString();return capability===""?void 0:capability}else if(capabilities.length>1)return capabilities.join(",")}}
//# sourceMappingURL=pipeline-actions.js.map
