{
  "version": 3,
  "sources": ["user-pool-domain.ts"],
  "sourcesContent": ["import { ICertificate } from '../../aws-certificatemanager';\nimport { IResource, Resource, Stack, Token } from '../../core';\nimport { AwsCustomResource, AwsCustomResourcePolicy, AwsSdkCall, PhysicalResourceId } from '../../custom-resources';\nimport { Construct } from 'constructs';\nimport { CfnUserPoolDomain } from './cognito.generated';\nimport { IUserPool } from './user-pool';\nimport { UserPoolClient } from './user-pool-client';\n\n                                         \nexport interface IUserPoolDomain extends IResource {\n                                                                                                                                                                                                                                                                 \n  readonly domainName: string;\n}\n\n                                                                                                                                                             \nexport interface CustomDomainOptions {\n                                                                                             \n  readonly domainName: string;\n\n                                                               \n  readonly certificate: ICertificate;\n}\n\n                                                                                                                                                                           \nexport interface CognitoDomainOptions {\n                                                                                                         \n  readonly domainPrefix: string;\n}\n\n                                             \nexport interface UserPoolDomainOptions {\n                                                                                                                                                                                                                                                                                                                                  \n  readonly customDomain?: CustomDomainOptions;\n\n                                                                                                                                                                                                                                                                                                                                            \n  readonly cognitoDomain?: CognitoDomainOptions;\n}\n\n                                             \nexport interface UserPoolDomainProps extends UserPoolDomainOptions {\n                                                                         \n  readonly userPool: IUserPool;\n}\n\n                                    \nexport class UserPoolDomain extends Resource implements IUserPoolDomain {\n                                                              \n  public static fromDomainName(scope: Construct, id: string, userPoolDomainName: string): IUserPoolDomain {\n    class Import extends Resource implements IUserPoolDomain {\n      public readonly domainName = userPoolDomainName;\n    }\n\n    return new Import(scope, id);\n  }\n\n  public readonly domainName: string;\n  private isCognitoDomain: boolean;\n\n  private cloudFrontCustomResource?: AwsCustomResource;\n\n  constructor(scope: Construct, id: string, props: UserPoolDomainProps) {\n    super(scope, id);\n\n    if (!!props.customDomain === !!props.cognitoDomain) {\n      throw new Error('One of, and only one of, cognitoDomain or customDomain must be specified');\n    }\n\n    if (props.cognitoDomain?.domainPrefix &&\n      !Token.isUnresolved(props.cognitoDomain?.domainPrefix) &&\n      !/^[a-z0-9-]+$/.test(props.cognitoDomain.domainPrefix)) {\n\n      throw new Error('domainPrefix for cognitoDomain can contain only lowercase alphabets, numbers and hyphens');\n    }\n\n    this.isCognitoDomain = !!props.cognitoDomain;\n\n    const domainName = props.cognitoDomain?.domainPrefix || props.customDomain?.domainName!;\n    const resource = new CfnUserPoolDomain(this, 'Resource', {\n      userPoolId: props.userPool.userPoolId,\n      domain: domainName,\n      customDomainConfig: props.customDomain ? { certificateArn: props.customDomain.certificate.certificateArn } : undefined,\n    });\n\n    this.domainName = resource.ref;\n  }\n\n                                                                                                     \n  public get cloudFrontDomainName(): string {\n    if (!this.cloudFrontCustomResource) {\n      const sdkCall: AwsSdkCall = {\n        service: 'CognitoIdentityServiceProvider',\n        action: 'describeUserPoolDomain',\n        parameters: {\n          Domain: this.domainName,\n        },\n        physicalResourceId: PhysicalResourceId.of(this.domainName),\n      };\n      this.cloudFrontCustomResource = new AwsCustomResource(this, 'CloudFrontDomainName', {\n        resourceType: 'Custom::UserPoolCloudFrontDomainName',\n        onCreate: sdkCall,\n        onUpdate: sdkCall,\n        policy: AwsCustomResourcePolicy.fromSdkCalls({\n          // DescribeUserPoolDomain only supports access level '*'\n          // https://docs.aws.amazon.com/IAM/latest/UserGuide/list_amazoncognitouserpools.html#amazoncognitouserpools-actions-as-permissions\n          resources: ['*'],\n        }),\n      });\n    }\n    return this.cloudFrontCustomResource.getResponseField('DomainDescription.CloudFrontDistribution');\n  }\n\n                                                                     \n  public baseUrl(): string {\n    if (this.isCognitoDomain) {\n      return `https://${this.domainName}.auth.${Stack.of(this).region}.amazoncognito.com`;\n    }\n    return `https://${this.domainName}`;\n  }\n\n                                                                                                                                                                                                                                                                                                 \n  public signInUrl(client: UserPoolClient, options: SignInUrlOptions): string {\n    let responseType: string;\n    if (client.oAuthFlows.authorizationCodeGrant) {\n      responseType = 'code';\n    } else if (client.oAuthFlows.implicitCodeGrant) {\n      responseType = 'token';\n    } else {\n      throw new Error('signInUrl is not supported for clients without authorizationCodeGrant or implicitCodeGrant flow enabled');\n    }\n    const path = options.signInPath ?? '/login';\n    return `${this.baseUrl()}${path}?client_id=${client.userPoolClientId}&response_type=${responseType}&redirect_uri=${options.redirectUri}`;\n  }\n}\n\n                                                              \nexport interface SignInUrlOptions {\n                                                   \n  readonly redirectUri: string;\n\n                                                                                             \n  readonly signInPath?: string;\n}\n"],
  "mappings": "qNACA,OAAA,QAAA,cACA,mBAAA,QAAA,0BAEA,oBAAA,QAAA,uBAyCA,4BAAoC,QAAA,QAAQ,CAe1C,YAAY,MAAkB,GAAY,MAA0B,iBAClE,MAAM,MAAO,IAEb,8EAAI,CAAC,CAAC,MAAM,cAAiB,CAAC,CAAC,MAAM,cACnC,KAAM,IAAI,OAAM,4EAGlB,GAAI,KAAA,MAAM,iBAAa,MAAA,KAAA,OAAA,OAAA,GAAE,eACvB,CAAC,OAAA,MAAM,aAAY,IAAC,MAAM,iBAAa,MAAA,KAAA,OAAA,OAAA,GAAE,eACzC,CAAC,eAAe,KAAK,MAAM,cAAc,cAEzC,KAAM,IAAI,OAAM,4FAGlB,KAAK,gBAAkB,CAAC,CAAC,MAAM,cAE/B,KAAM,YAAa,KAAA,MAAM,iBAAa,MAAA,KAAA,OAAA,OAAA,GAAE,eAAgB,KAAA,MAAM,gBAAY,MAAA,KAAA,OAAA,OAAA,GAAE,YACtE,SAAW,GAAI,qBAAA,kBAAkB,KAAM,WAAY,CACvD,WAAY,MAAM,SAAS,WAC3B,OAAQ,WACR,mBAAoB,MAAM,aAAe,CAAE,eAAgB,MAAM,aAAa,YAAY,gBAAmB,SAG/G,KAAK,WAAa,SAAS,UApCf,gBAAe,MAAkB,GAAY,mBAA0B,CACnF,oBAAqB,QAAA,QAAQ,CAA7B,aAAA,qBACkB,KAAA,WAAa,oBAG/B,MAAO,IAAI,QAAO,MAAO,OAmChB,uBAAoB,CAC7B,GAAI,CAAC,KAAK,yBAA0B,CAClC,KAAM,SAAsB,CAC1B,QAAS,iCACT,OAAQ,yBACR,WAAY,CACV,OAAQ,KAAK,YAEf,mBAAoB,mBAAA,mBAAmB,GAAG,KAAK,aAEjD,KAAK,yBAA2B,GAAI,oBAAA,kBAAkB,KAAM,uBAAwB,CAClF,aAAc,uCACd,SAAU,QACV,SAAU,QACV,OAAQ,mBAAA,wBAAwB,aAAa,CAG3C,UAAW,CAAC,SAIlB,MAAO,MAAK,yBAAyB,iBAAiB,4CAIjD,SAAO,CACZ,MAAI,MAAK,gBACA,WAAW,KAAK,mBAAmB,OAAA,MAAM,GAAG,MAAM,2BAEpD,WAAW,KAAK,aAIlB,UAAU,OAAwB,QAAyB,yJAChE,GAAI,cACJ,GAAI,OAAO,WAAW,uBACpB,aAAe,eACN,OAAO,WAAW,kBAC3B,aAAe,YAEf,MAAM,IAAI,OAAM,2GAElB,KAAM,MAAI,IAAG,QAAQ,cAAU,MAAA,KAAA,OAAA,GAAI,SACnC,MAAO,GAAG,KAAK,YAAY,kBAAkB,OAAO,kCAAkC,6BAA6B,QAAQ,eArF/H,QAAA,eAAA",
  "names": []
}
