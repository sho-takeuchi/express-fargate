{
  "version": 3,
  "sources": ["vpn.ts"],
  "sourcesContent": ["import * as net from 'net';\nimport * as cloudwatch from '../../aws-cloudwatch';\nimport { IResource, Resource, Token } from '../../core';\nimport { Construct } from 'constructs';\nimport {\n  CfnCustomerGateway,\n  CfnVPNConnection,\n  CfnVPNConnectionRoute,\n  CfnVPNGateway,\n} from './ec2.generated';\nimport { IVpc, SubnetSelection } from './vpc';\n\nexport interface IVpnConnection extends IResource {\n                                              \n  readonly vpnId: string;\n\n                                                \n  readonly customerGatewayId: string;\n\n                                                        \n  readonly customerGatewayIp: string;\n\n                                                 \n  readonly customerGatewayAsn: number;\n}\n\n                                                \nexport interface IVpnGateway extends IResource {\n\n                                               \n  readonly gatewayId: string\n}\n\nexport interface VpnTunnelOption {\n                                                                                                                                                                                                                                                                                                                                            \n  readonly preSharedKey?: string;\n\n                                                                                                                                                                                                                                                                                                     \n  readonly tunnelInsideCidr?: string;\n}\n\nexport interface VpnConnectionOptions {\n                                                        \n  readonly ip: string;\n\n                                                                          \n  readonly asn?: number;\n\n                                                                                                                                      \n  readonly staticRoutes?: string[];\n\n                                                                                                                                                                                  \n  readonly tunnelOptions?: VpnTunnelOption[];\n}\n\n                                    \nexport interface VpnGatewayProps {\n\n                                     \n  readonly type: string;\n\n                                                                                              \n  readonly amazonSideAsn?: number;\n}\n\n                                                        \nexport interface EnableVpnGatewayOptions extends VpnGatewayProps {\n                                                                                                                     \n  readonly vpnRoutePropagation?: SubnetSelection[]\n}\n\nexport interface VpnConnectionProps extends VpnConnectionOptions {\n                                       \n  readonly vpc: IVpc;\n}\n\n                                   \nexport enum VpnConnectionType {\n                                                 \n  IPSEC_1 = 'ipsec.1',\n\n                                                                                                    \n  DUMMY = 'dummy'\n}\n\n                                                                                              \nexport class VpnGateway extends Resource implements IVpnGateway {\n\n                                               \n  public readonly gatewayId: string;\n\n  constructor(scope: Construct, id: string, props: VpnGatewayProps) {\n    super(scope, id);\n\n    // This is 'Default' instead of 'Resource', because using 'Default' will generate\n    // a logical ID for a VpnGateway which is exactly the same as the logical ID that used\n    // to be created for the CfnVPNGateway (and 'Resource' would not do that).\n    const vpnGW = new CfnVPNGateway(this, 'Default', props);\n    this.gatewayId = vpnGW.ref;\n  }\n}\n                                                                          \nexport class VpnConnection extends Resource implements IVpnConnection {\n                                                                                             \n  public static metricAll(metricName: string, props?: cloudwatch.MetricOptions): cloudwatch.Metric {\n    return new cloudwatch.Metric({\n      namespace: 'AWS/VPN',\n      metricName,\n      ...props,\n    });\n  }\n\n                                                                                                                                    \n  public static metricAllTunnelState(props?: cloudwatch.MetricOptions): cloudwatch.Metric {\n    return this.metricAll('TunnelState', { statistic: 'avg', ...props });\n  }\n\n                                                                                                                                  \n  public static metricAllTunnelDataIn(props?: cloudwatch.MetricOptions): cloudwatch.Metric {\n    return this.metricAll('TunnelDataIn', { statistic: 'sum', ...props });\n  }\n\n                                                                                                             \n  public static metricAllTunnelDataOut(props?: cloudwatch.MetricOptions): cloudwatch.Metric {\n    return this.metricAll('TunnelDataOut', { statistic: 'sum', ...props });\n  }\n\n  public readonly vpnId: string;\n  public readonly customerGatewayId: string;\n  public readonly customerGatewayIp: string;\n  public readonly customerGatewayAsn: number;\n\n  constructor(scope: Construct, id: string, props: VpnConnectionProps) {\n    super(scope, id);\n\n    if (!props.vpc.vpnGatewayId) {\n      props.vpc.enableVpnGateway({\n        type: 'ipsec.1',\n        amazonSideAsn: props.asn,\n      });\n    }\n\n    if (!Token.isUnresolved(props.ip) && !net.isIPv4(props.ip)) {\n      throw new Error(`The \\`ip\\` ${props.ip} is not a valid IPv4 address.`);\n    }\n\n    const type = VpnConnectionType.IPSEC_1;\n    const bgpAsn = props.asn || 65000;\n\n    const customerGateway = new CfnCustomerGateway(this, 'CustomerGateway', {\n      bgpAsn,\n      ipAddress: props.ip,\n      type,\n    });\n\n    this.customerGatewayId = customerGateway.ref;\n    this.customerGatewayAsn = bgpAsn;\n    this.customerGatewayIp = props.ip;\n\n    // Validate tunnel options\n    if (props.tunnelOptions) {\n      if (props.tunnelOptions.length > 2) {\n        throw new Error('Cannot specify more than two `tunnelOptions`');\n      }\n\n      if (props.tunnelOptions.length === 2 && props.tunnelOptions[0].tunnelInsideCidr === props.tunnelOptions[1].tunnelInsideCidr) {\n        throw new Error(`Same ${props.tunnelOptions[0].tunnelInsideCidr} \\`tunnelInsideCidr\\` cannot be used for both tunnels.`);\n      }\n\n      props.tunnelOptions.forEach((options, index) => {\n        if (options.preSharedKey && !Token.isUnresolved(options.preSharedKey) && !/^[a-zA-Z1-9._][a-zA-Z\\d._]{7,63}$/.test(options.preSharedKey)) {\n          /* eslint-disable max-len */\n          throw new Error(`The \\`preSharedKey\\` ${options.preSharedKey} for tunnel ${index + 1} is invalid. Allowed characters are alphanumeric characters and ._. Must be between 8 and 64 characters in length and cannot start with zero (0).`);\n          /* eslint-enable max-len */\n        }\n\n        if (options.tunnelInsideCidr) {\n          if (RESERVED_TUNNEL_INSIDE_CIDR.includes(options.tunnelInsideCidr)) {\n            throw new Error(`The \\`tunnelInsideCidr\\` ${options.tunnelInsideCidr} for tunnel ${index + 1} is a reserved inside CIDR.`);\n          }\n\n          if (!/^169\\.254\\.\\d{1,3}\\.\\d{1,3}\\/30$/.test(options.tunnelInsideCidr)) {\n            /* eslint-disable-next-line max-len */\n            throw new Error(`The \\`tunnelInsideCidr\\` ${options.tunnelInsideCidr} for tunnel ${index + 1} is not a size /30 CIDR block from the 169.254.0.0/16 range.`);\n          }\n        }\n      });\n    }\n\n    const vpnConnection = new CfnVPNConnection(this, 'Resource', {\n      type,\n      customerGatewayId: customerGateway.ref,\n      staticRoutesOnly: props.staticRoutes ? true : false,\n      vpnGatewayId: props.vpc.vpnGatewayId,\n      vpnTunnelOptionsSpecifications: props.tunnelOptions,\n    });\n\n    this.vpnId = vpnConnection.ref;\n\n    if (props.staticRoutes) {\n      props.staticRoutes.forEach(route => {\n        new CfnVPNConnectionRoute(this, `Route${route.replace(/[^\\d]/g, '')}`, {\n          destinationCidrBlock: route,\n          vpnConnectionId: this.vpnId,\n        });\n      });\n    }\n  }\n}\n\nexport const RESERVED_TUNNEL_INSIDE_CIDR = [\n  '169.254.0.0/30',\n  '169.254.1.0/30',\n  '169.254.2.0/30',\n  '169.254.3.0/30',\n  '169.254.4.0/30',\n  '169.254.5.0/30',\n  '169.254.169.252/30',\n];\n"],
  "mappings": "wSAAA,IAAA,QAAA,OACA,WAAA,QAAA,wBACA,OAAA,QAAA,cAEA,gBAAA,QAAA,mBAyEA,GAAY,mBAAZ,AAAA,UAAY,mBAAiB,CAE3B,mBAAA,QAAA,UAGA,mBAAA,MAAA,UALU,kBAAA,QAAA,mBAAA,SAAA,kBAAiB,KAS7B,wBAAgC,QAAA,QAAQ,CAKtC,YAAY,MAAkB,GAAY,MAAsB,CAC9D,MAAM,MAAO,uEAKb,KAAM,OAAQ,GAAI,iBAAA,cAAc,KAAM,UAAW,OACjD,KAAK,UAAY,MAAM,KAZ3B,QAAA,WAAA,wGAgBA,2BAAmC,QAAA,QAAQ,CA8BzC,YAAY,MAAkB,GAAY,MAAyB,CACjE,MAAM,MAAO,IASb,yEAPK,MAAM,IAAI,cACb,MAAM,IAAI,iBAAiB,CACzB,KAAM,UACN,cAAe,MAAM,MAIrB,CAAC,OAAA,MAAM,aAAa,MAAM,KAAO,CAAC,IAAI,OAAO,MAAM,IACrD,KAAM,IAAI,OAAM,cAAc,MAAM,mCAGtC,KAAM,MAAO,kBAAkB,QACzB,OAAS,MAAM,KAAO,KAEtB,gBAAkB,GAAI,iBAAA,mBAAmB,KAAM,kBAAmB,CACtE,OACA,UAAW,MAAM,GACjB,OAQF,GALA,KAAK,kBAAoB,gBAAgB,IACzC,KAAK,mBAAqB,OAC1B,KAAK,kBAAoB,MAAM,GAG3B,MAAM,cAAe,CACvB,GAAI,MAAM,cAAc,OAAS,EAC/B,KAAM,IAAI,OAAM,gDAGlB,GAAI,MAAM,cAAc,SAAW,GAAK,MAAM,cAAc,GAAG,mBAAqB,MAAM,cAAc,GAAG,iBACzG,KAAM,IAAI,OAAM,QAAQ,MAAM,cAAc,GAAG,0EAGjD,MAAM,cAAc,QAAQ,CAAC,QAAS,QAAS,CAC7C,GAAI,QAAQ,cAAgB,CAAC,OAAA,MAAM,aAAa,QAAQ,eAAiB,CAAC,oCAAoC,KAAK,QAAQ,cAEzH,KAAM,IAAI,OAAM,wBAAwB,QAAQ,2BAA2B,MAAQ,sJAIrF,GAAI,QAAQ,iBAAkB,CAC5B,GAAI,QAAA,4BAA4B,SAAS,QAAQ,kBAC/C,KAAM,IAAI,OAAM,4BAA4B,QAAQ,+BAA+B,MAAQ,gCAG7F,GAAI,CAAC,mCAAmC,KAAK,QAAQ,kBAEnD,KAAM,IAAI,OAAM,4BAA4B,QAAQ,+BAA+B,MAAQ,oEAMnG,KAAM,eAAgB,GAAI,iBAAA,iBAAiB,KAAM,WAAY,CAC3D,KACA,kBAAmB,gBAAgB,IACnC,iBAAkB,QAAM,aACxB,aAAc,MAAM,IAAI,aACxB,+BAAgC,MAAM,gBAGxC,KAAK,MAAQ,cAAc,IAEvB,MAAM,cACR,MAAM,aAAa,QAAQ,OAAQ,CACjC,GAAI,iBAAA,sBAAsB,KAAM,QAAQ,MAAM,QAAQ,SAAU,MAAO,CACrE,qBAAsB,MACtB,gBAAiB,KAAK,gBAnGhB,WAAU,WAAoB,MAAgC,gFACnE,GAAI,YAAW,OAAO,CAC3B,UAAW,UACX,cACG,cAKO,sBAAqB,MAAgC,gFAC1D,KAAK,UAAU,cAAe,CAAE,UAAW,SAAU,cAIhD,uBAAsB,MAAgC,gFAC3D,KAAK,UAAU,eAAgB,CAAE,UAAW,SAAU,cAIjD,wBAAuB,MAAgC,gFAC5D,KAAK,UAAU,gBAAiB,CAAE,UAAW,SAAU,SAtBlE,QAAA,cAAA,iHA4Ga,QAAA,4BAA8B,CACzC,iBACA,iBACA,iBACA,iBACA,iBACA,iBACA",
  "names": []
}
