{
  "version": 3,
  "sources": ["batch.ts"],
  "sourcesContent": ["import * as events from '../../aws-events';\nimport * as iam from '../../aws-iam';\nimport { Names } from '../../core';\nimport { IConstruct } from 'constructs';\nimport { addToDeadLetterQueueResourcePolicy, bindBaseTargetConfig, singletonEventRole, TargetBaseProps } from './util';\n\n                                               \nexport interface BatchJobProps extends TargetBaseProps {\n                                                                                                                                                                \n  readonly event?: events.RuleTargetInput;\n\n                                                                                                                                                                              \n  readonly size?: number;\n\n                                                                                                                                             \n  readonly attempts?: number;\n\n                                                                                           \n  readonly jobName?: string;\n}\n\n                                                                                                                                                                                                                                                                                        \nexport class BatchJob implements events.IRuleTarget {\n  constructor(\n    /**\n     * The JobQueue arn\n     */\n    private readonly jobQueueArn: string,\n\n    /**\n     * The JobQueue Resource\n     */\n    private readonly jobQueueScope: IConstruct,\n\n    /**\n     * The jobDefinition arn\n     */\n    private readonly jobDefinitionArn: string,\n\n    /**\n     * The JobQueue Resource\n     */\n    private readonly jobDefinitionScope: IConstruct,\n    private readonly props: BatchJobProps = {},\n  ) { }\n\n                                                                                                                                  \n  public bind(rule: events.IRule, _id?: string): events.RuleTargetConfig {\n    const batchParameters: events.CfnRule.BatchParametersProperty = {\n      jobDefinition: this.jobDefinitionArn,\n      jobName: this.props.jobName ?? Names.nodeUniqueId(rule.node),\n      arrayProperties: this.props.size ? { size: this.props.size } : undefined,\n      retryStrategy: this.props.attempts ? { attempts: this.props.attempts } : undefined,\n    };\n\n    if (this.props.deadLetterQueue) {\n      addToDeadLetterQueueResourcePolicy(rule, this.props.deadLetterQueue);\n    }\n\n    return {\n      ...bindBaseTargetConfig(this.props),\n      arn: this.jobQueueArn,\n      // When scoping resource-level access for job submission, you must provide both job queue and job definition resource types.\n      // https://docs.aws.amazon.com/batch/latest/userguide/ExamplePolicies_BATCH.html#iam-example-restrict-job-def\n      role: singletonEventRole(this.jobDefinitionScope, [\n        new iam.PolicyStatement({\n          actions: ['batch:SubmitJob'],\n          resources: [\n            this.jobDefinitionArn,\n            this.jobQueueArn,\n          ],\n        }),\n      ]),\n      input: this.props.event,\n      targetResource: this.jobQueueScope,\n      batchParameters,\n    };\n  }\n}\n"],
  "mappings": "+MACA,IAAA,QAAA,iBACA,OAAA,QAAA,cAEA,OAAA,QAAA,UAkBA,cAAqB,CACnB,YAImB,YAKA,cAKA,iBAKA,mBACA,MAAuB,GAAE,CAhBzB,KAAA,YAAA,YAKA,KAAA,cAAA,cAKA,KAAA,iBAAA,iBAKA,KAAA,mBAAA,mBACA,KAAA,MAAA,kFAIZ,KAAK,KAAoB,IAAY,mEAC1C,KAAM,iBAA0D,CAC9D,cAAe,KAAK,iBACpB,QAAO,IAAE,KAAK,MAAM,WAAO,MAAA,KAAA,OAAA,GAAI,OAAA,MAAM,aAAa,KAAK,MACvD,gBAAiB,KAAK,MAAM,KAAO,CAAE,KAAM,KAAK,MAAM,MAAS,OAC/D,cAAe,KAAK,MAAM,SAAW,CAAE,SAAU,KAAK,MAAM,UAAa,QAG3E,MAAI,MAAK,MAAM,iBACb,OAAA,mCAAmC,KAAM,KAAK,MAAM,iBAG/C,IACF,OAAA,qBAAqB,KAAK,OAC7B,IAAK,KAAK,YAGV,KAAM,OAAA,mBAAmB,KAAK,mBAAoB,CAChD,GAAI,KAAI,gBAAgB,CACtB,QAAS,CAAC,mBACV,UAAW,CACT,KAAK,iBACL,KAAK,iBAIX,MAAO,KAAK,MAAM,MAClB,eAAgB,KAAK,cACrB,kBArDN,QAAA,SAAA",
  "names": []
}
