{
  "version": 3,
  "sources": ["provider.ts"],
  "sourcesContent": ["import * as path from 'path';\nimport * as ec2 from '../../../aws-ec2';\nimport * as iam from '../../../aws-iam';\nimport * as lambda from '../../../aws-lambda';\nimport * as logs from '../../../aws-logs';\nimport { Duration } from '../../../core';\nimport { Construct } from 'constructs';\nimport * as consts from './runtime/consts';\nimport { calculateRetryPolicy } from './util';\nimport { WaiterStateMachine } from './waiter-state-machine';\n\n// keep this import separate from other imports to reduce chance for merge conflicts with v2-main\n// eslint-disable-next-line no-duplicate-imports, import/order\nimport { CustomResourceProviderConfig, ICustomResourceProvider } from '../../../aws-cloudformation';\n\nconst RUNTIME_HANDLER_PATH = path.join(__dirname, 'runtime');\nconst FRAMEWORK_HANDLER_TIMEOUT = Duration.minutes(15); // keep it simple for now\n\n                                                                  \nexport interface ProviderProps {\n\n                                                                                                                                                                                                                                                                                                                                                                                                                      \n  readonly onEventHandler: lambda.IFunction;\n\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \n  readonly isCompleteHandler?: lambda.IFunction;\n\n                                                                                                                                                                                                                                                                                                                                                                          \n  readonly queryInterval?: Duration;\n\n                                                                                                                                                                                        \n  readonly totalTimeout?: Duration;\n\n                                                                                                                                                                                                                                                                                              \n  readonly logRetention?: logs.RetentionDays;\n\n                                                                                                                               \n  readonly vpc?: ec2.IVpc;\n\n                                                                                                                                                                                                                                                                                               \n  readonly vpcSubnets?: ec2.SubnetSelection;\n\n                                                                                                                                                                                                                                                                       \n  readonly securityGroups?: ec2.ISecurityGroup[];\n\n                                                                                                                                                                                                                                   \n  readonly role?: iam.IRole;\n\n                                                                                                                                                             \n  readonly providerFunctionName?: string;\n}\n\n                                                                  \nexport class Provider extends Construct implements ICustomResourceProvider {\n\n                                                                                                                                         \n  public readonly onEventHandler: lambda.IFunction;\n\n                                                                                                                                              \n  public readonly isCompleteHandler?: lambda.IFunction;\n\n                                                                                                                    \n  public readonly serviceToken: string;\n\n  private readonly entrypoint: lambda.Function;\n  private readonly logRetention?: logs.RetentionDays;\n  private readonly vpc?: ec2.IVpc;\n  private readonly vpcSubnets?: ec2.SubnetSelection;\n  private readonly securityGroups?: ec2.ISecurityGroup[];\n  private readonly role?: iam.IRole;\n\n  constructor(scope: Construct, id: string, props: ProviderProps) {\n    super(scope, id);\n\n    if (!props.isCompleteHandler && (props.queryInterval || props.totalTimeout)) {\n      throw new Error('\"queryInterval\" and \"totalTimeout\" can only be configured if \"isCompleteHandler\" is specified. '\n        + 'Otherwise, they have no meaning');\n    }\n\n    this.onEventHandler = props.onEventHandler;\n    this.isCompleteHandler = props.isCompleteHandler;\n\n    this.logRetention = props.logRetention;\n    this.vpc = props.vpc;\n    this.vpcSubnets = props.vpcSubnets;\n    this.securityGroups = props.securityGroups;\n\n    this.role = props.role;\n\n    const onEventFunction = this.createFunction(consts.FRAMEWORK_ON_EVENT_HANDLER_NAME, props.providerFunctionName);\n\n    if (this.isCompleteHandler) {\n      const isCompleteFunction = this.createFunction(consts.FRAMEWORK_IS_COMPLETE_HANDLER_NAME);\n      const timeoutFunction = this.createFunction(consts.FRAMEWORK_ON_TIMEOUT_HANDLER_NAME);\n\n      const retry = calculateRetryPolicy(props);\n      const waiterStateMachine = new WaiterStateMachine(this, 'waiter-state-machine', {\n        isCompleteHandler: isCompleteFunction,\n        timeoutHandler: timeoutFunction,\n        backoffRate: retry.backoffRate,\n        interval: retry.interval,\n        maxAttempts: retry.maxAttempts,\n      });\n      // the on-event entrypoint is going to start the execution of the waiter\n      onEventFunction.addEnvironment(consts.WAITER_STATE_MACHINE_ARN_ENV, waiterStateMachine.stateMachineArn);\n      waiterStateMachine.grantStartExecution(onEventFunction);\n    }\n\n    this.entrypoint = onEventFunction;\n    this.serviceToken = this.entrypoint.functionArn;\n  }\n\n                                                                                                                          \n  public bind(_scope: Construct): CustomResourceProviderConfig {\n    return {\n      serviceToken: this.entrypoint.functionArn,\n    };\n  }\n\n  private createFunction(entrypoint: string, name?: string) {\n    const fn = new lambda.Function(this, `framework-${entrypoint}`, {\n      code: lambda.Code.fromAsset(RUNTIME_HANDLER_PATH),\n      description: `AWS CDK resource provider framework - ${entrypoint} (${this.node.path})`.slice(0, 256),\n      runtime: lambda.Runtime.NODEJS_12_X,\n      handler: `framework.${entrypoint}`,\n      timeout: FRAMEWORK_HANDLER_TIMEOUT,\n      logRetention: this.logRetention,\n      vpc: this.vpc,\n      vpcSubnets: this.vpcSubnets,\n      securityGroups: this.securityGroups,\n      role: this.role,\n      functionName: name,\n    });\n\n    fn.addEnvironment(consts.USER_ON_EVENT_FUNCTION_ARN_ENV, this.onEventHandler.functionArn);\n    this.onEventHandler.grantInvoke(fn);\n\n    if (this.isCompleteHandler) {\n      fn.addEnvironment(consts.USER_IS_COMPLETE_FUNCTION_ARN_ENV, this.isCompleteHandler.functionArn);\n      this.isCompleteHandler.grantInvoke(fn);\n    }\n\n    return fn;\n  }\n}\n"],
  "mappings": "kNAAA,KAAA,QAAA,QAGA,OAAA,QAAA,uBAEA,OAAA,QAAA,iBACA,aAAA,QAAA,cACA,OAAA,QAAA,oBACA,OAAA,QAAA,UACA,uBAAA,QAAA,0BAMM,qBAAuB,KAAK,KAAK,UAAW,WAC5C,0BAA4B,OAAA,SAAS,QAAQ,IAqCnD,sBAA8B,cAAA,SAAS,CAkBrC,YAAY,MAAkB,GAAY,MAAoB,CAC5D,MAAM,MAAO,IAEb,6EAAI,CAAC,MAAM,mBAAsB,OAAM,eAAiB,MAAM,cAC5D,KAAM,IAAI,OAAM,kIAIlB,KAAK,eAAiB,MAAM,eAC5B,KAAK,kBAAoB,MAAM,kBAE/B,KAAK,aAAe,MAAM,aAC1B,KAAK,IAAM,MAAM,IACjB,KAAK,WAAa,MAAM,WACxB,KAAK,eAAiB,MAAM,eAE5B,KAAK,KAAO,MAAM,KAElB,KAAM,iBAAkB,KAAK,eAAe,OAAO,gCAAiC,MAAM,sBAE1F,GAAI,KAAK,kBAAmB,CAC1B,KAAM,oBAAqB,KAAK,eAAe,OAAO,oCAChD,gBAAkB,KAAK,eAAe,OAAO,mCAE7C,MAAQ,OAAA,qBAAqB,OAC7B,mBAAqB,GAAI,wBAAA,mBAAmB,KAAM,uBAAwB,CAC9E,kBAAmB,mBACnB,eAAgB,gBAChB,YAAa,MAAM,YACnB,SAAU,MAAM,SAChB,YAAa,MAAM,cAGrB,gBAAgB,eAAe,OAAO,6BAA8B,mBAAmB,iBACvF,mBAAmB,oBAAoB,iBAGzC,KAAK,WAAa,gBAClB,KAAK,aAAe,KAAK,WAAW,YAI/B,KAAK,OAAiB,CAC3B,MAAO,CACL,aAAc,KAAK,WAAW,aAI1B,eAAe,WAAoB,KAAa,CACtD,KAAM,IAAK,GAAI,QAAO,SAAS,KAAM,aAAa,aAAc,CAC9D,KAAM,OAAO,KAAK,UAAU,sBAC5B,YAAa,yCAAyC,eAAe,KAAK,KAAK,QAAQ,MAAM,EAAG,KAChG,QAAS,OAAO,QAAQ,YACxB,QAAS,aAAa,aACtB,QAAS,0BACT,aAAc,KAAK,aACnB,IAAK,KAAK,IACV,WAAY,KAAK,WACjB,eAAgB,KAAK,eACrB,KAAM,KAAK,KACX,aAAc,OAGhB,UAAG,eAAe,OAAO,+BAAgC,KAAK,eAAe,aAC7E,KAAK,eAAe,YAAY,IAE5B,KAAK,mBACP,IAAG,eAAe,OAAO,kCAAmC,KAAK,kBAAkB,aACnF,KAAK,kBAAkB,YAAY,KAG9B,IAzFX,QAAA,SAAA",
  "names": []
}
